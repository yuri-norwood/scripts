#!/bin/sh

#
# git ignore - Generate a .gitignore file in the current directory
#

set -e

IGNORE=".gitignore"
API="https://www.gitignore.io/api/<type>"

err() {
	echo "ERROR: $*" 1>&2
}

die() {
	err "$*"
	exit 1
}

has() {
	if [ -x "$(command -v "$1")" ]
	then
		return 0
	fi

	return 1
}

ignore() {
	_URL="$(echo "${API}" | sed "s/<type>/$1/g")"

	if has wget
	then
		wget "${_URL}" -q -O -
	elif has curl
	then
		curl "${_URL}" -sL
	fi >> "${IGNORE}"

	git add "${IGNORE}"
	git commit -m "Ignore ${1} artifacts" "${IGNORE}"
}

while [ "$#" -gt 0 ]
do
	case "$1" in
		'-m')
			MKDIR="TRUE"
		;;
		'-d'|'-dm'|'-md')
			if [ ! "$2" ]
			then
				die "flag '$1' expects '<DIR>' argument"
			fi

			if [ "$MKDIR" = "TRUE" ] || [ "$1" = "-dm" ] || [ "$1" = "-md" ]
			then
				mkdir -p "$2"
			fi

			if [ ! -d "$2" ]
			then
				die "flag '$1' requires existing directory, got: '$2'"
			fi

			ignore "$1"

			shift # pop $1 so $2 gets popped later
		;;
		*)
			ignore "$1"
		;;
	esac

	shift # pop $1
done
